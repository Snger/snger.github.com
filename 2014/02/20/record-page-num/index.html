
<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
  <title>记录上次列表所在分页数 | The Same Summer.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="author" content="Snger">
  
  <meta name="description" content="需求描述：“异步获取列表的，如果点击列表的某一行进入详情页，在详情页处理完要返回列表页的时候，能否返回之前所在的分页？ ”">
  
  
  <meta property="og:title" content="记录上次列表所在分页数"/>
  <meta property="og:site_name" content="The Same Summer."/>
  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="The Same Summer." type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.min.css" type="text/css">
</head>

<body>
  <header>
    <div class="clearfix">
	<div id="logo">
		<a href="/"><img src="/img/logo.svg" width="360" height="108" alt="Snger"/></a>
		<hgroup>
			<h1 class="site-name"><a href="/">The Same Summer.</a></h1>
			<h2 class="blog-motto"></h2>
		</hgroup>
	 </div>
	 <div class="navbar"><a class="navbutton" href="#"><i class="icon-menu"></i></a></div>
	<nav>
		<ul>
		 
			<li><a href="/">博客</a></li>
		
			<li><a href="/archives">存档</a></li>
		
			<li><a href="/about">关于</a></li>
		
			<li><a href="/projects">专题</a></li>
		
			<li><a href="/lab">实验室</a></li>
		
			<li> <a title="shall we talk" href='javascript:(
function() {
	function loadCss() {
		var e = document.createElement("link");
		e.setAttribute("type", "text/css");
		e.setAttribute("rel", "stylesheet");
		e.setAttribute("href", f);
		e.setAttribute("class", l);
		document.body.appendChild(e)
	}
 
	function removeCssClass() {
		var e = document.getElementsByClassName(l);
		for (var t = 0; t < e.length; t++) {
			document.body.removeChild(e[t])
		}
	}
 
	function showLight() {
		var e = document.createElement("div");
		e.setAttribute("class", a);
		document.body.appendChild(e);
		setTimeout(function() {
			document.body.removeChild(e)
		}, 100)
	}
 
	function getOffset(e) {
		return {
			height : e.offsetHeight,
			width : e.offsetWidth
		}
	}
 
	function elemFilter(i) {
		var s = getOffset(i);
		return s.height > e && s.height < n && s.width > t && s.width < r
	}
 
	function returnOffsetTop(e) {
		var t = e;
		var n = 0;
		while (!!t) {
			n += t.offsetTop;
			t = t.offsetParent
		}
		return n
	}
 
	function g() {
		var e = document.documentElement;
		if (!!window.innerWidth) {
			return window.innerHeight
		} else if (e && !isNaN(e.clientHeight)) {
			return e.clientHeight
		}
		return 0
	}
 
	function y() {
		if (window.pageYOffset) {
			return window.pageYOffset
		}
		return Math.max(document.documentElement.scrollTop, document.body.scrollTop)
	}
 
	function E(e) {
		var t = returnOffsetTop(e);
		return t >= w && t <= b + w
	}
 
	function S() {
		var e = document.createElement("audio");
		e.setAttribute("class", l);
		e.src = i[parseInt(10*Math.random())];
		e.loop = false;
		e.addEventListener("canplay", function() {
			setTimeout(function() {
				x(k)
			}, 500);
			setTimeout(function() {
				N();
				showLight();
				for (var e = 0; e < O.length; e++) {
					T(O[e])
				}
			}, 15500)
		}, true);
		e.addEventListener("ended", function() {
			N();
			removeCssClass()
		}, true);
		e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
		document.body.appendChild(e);
		e.play()
	}
 
	function x(e) {
		e.className += " " + s + " " + o
	}
 
	function T(e) {
		e.className += " " + s + " " + u[Math.floor(Math.random() * u.length)]
	}
 
	function N() {
		var e = document.getElementsByClassName(s);
		var t = new RegExp("\\b" + s + "\\b");
		for (var n = 0; n < e.length; ) {
			e[n].className = e[n].className.replace(t, "")
		}
	}

	function reset(){
		N();removeCssClass();
	}
 
	var e = 30;
	var t = 30;
	var n = 350;
	var r = 350;
	var i = ["/music/again-yui.mp3","/music/AiCongLingKaiShi-syz.mp3","/music/BieLaiWuYang-xtf.mp3","/music/DangChe-eason.mp3","/music/HaoJiuBuJian-eason.mp3","/music/LifeForRent-Dido.mp3","/music/TongLei-syz.mp3","/music/WoHuaiNianDe-syz.mp3","/music/youAreBeautiful.mp3","/music/youngForYou.mp3"];
	var s = "mw-harlem_shake_me";
	var o = "im_first";
	var u = ["im_drunk", "im_baked", "im_trippin", "im_blown"];
	var a = "mw-strobe_light";
	var f = "/css/harlem-shake-style.min.css";
	var l = "mw_added_css";
	var b = g();
	var w = y();
	var C = document.getElementsByTagName("*");
	var k = null;
	reset();
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (elemFilter(A)) {
			if (E(A)) {
				k = A;
				break
			}
		}
	}
	if (A === null) {
		console.warn("Could not find a node of the right size. Please try a different page.");
		return
	}
	loadCss();
	S();
	var O = [];
	for (var L = 0; L < C.length; L++) {
		var A = C[L];
		if (elemFilter(A)) {
			O.push(A)
		}
	}
})()    '>>_<</a>
			</li>
			<li><form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
				<label>Search</label>
					<input type="search" name="q" id="search" autocomplete="off" autocorrect="off" autocapitalize="off" maxlength="20" placeholder="Search" />
					<input type="hidden" name="q" value="site:snger.github.io">
				</form>
			</li>
		</ul>
	</nav>
</div>
<!-- var i = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake.mp3";
	var f = "//s3.amazonaws.com/source/css/harlem-shake-style.css"; -->
  </header>
  <div id="container">
    <div id="main" class="postpart">
	<header class="clearfix">
	  <h1><a href="/2014/02/20/record-page-num/" title="记录上次列表所在分页数">记录上次列表所在分页数</a></h1>
	  <p>By
	  
	 	 <a href="https://twitter.com/sjs_stef" title="Snger">Snger</a>
	  
	  on<time datetime="2014-02-20T05:54:29.000Z">Feb 20 2014</time></p>
	</header>
	<article>     
	     <p>需求描述：“异步获取列表的，如果点击列表的某一行进入详情页，在详情页处理完要返回列表页的时候，能否返回之前所在的分页？ ”</p>
<p>现有有两个可行的方案：1.使用 url参数 来记录之前的分页数；2.使用 HTML5 sessionStorage 记录之前的分页数；</p>
<p><strong>方案1：</strong>特点是可以特定某些链接跳回列表页时回到之前所在分页；缺点是改动文件多，改动量大，容易出错；宝贝-标题优化已使用这种方式；</p>
<p><strong>方案2：</strong>特点是对一个 session 进行分页数存储，无论哪个页面跳到列表页都可以回到之前所在分页；优点是只改 js；缺点是得针对 IE6、IE7 做兼容（已有方案可解决）；【个人推荐】</p>
<hr>
<h3 id="方案1">方案1</h3><p>进度（toushou-tbv3）：<br>a.已完成：素材-投放管理；<br>b.前端完成：素材-海报（跳回链接需在 flash 中添加）；<br>c.前端完成后发现无需（囧）：素材关联列表（所有）-》制作完成后跳到“我的关联列表”</p>
<p><strong>说明：</strong>改动了4个页面，分别对应1、2、3、4；第3步 a 的方法可能丢失分页参数（如果在操作页不是点击链接返回列表，而是用浏览器的返回按钮、或是 Mac 系统用双指回退），在之后异步 block 回传数据，用 js 渲染列表内容可避免这个问题；以下例子是 tbv3的素材-投放管理页的修改步骤；</p>
<h4 id="步骤：">步骤：</h4><ol>
<li>列表所在的 phtml 页面，添加<pre><code>&lt;input type="hidden" id="J_PageId" value="<?php echo $this->getRequest()->getParam('page_id','1');?>" /></code></pre></li>
<li>在异步加载的（block）html，给需要跳转链接记住上次所在分页的<a>上加 <code>class= J_LiA</code>；如果此链接不是使用 href 跳转而是用 onclick 控制，则分解 onclick 事件：链接放到 data-url 属性中；在第3步 a 中处理onclick 事件；</a></li>
<li><p>列表所在的 js 页面：<br> a. 对象中加入分页记录属性：</p>
 <pre><code>pageId : DOM.val(DOM.get("#J_PageId")),</code></pre>

<p> b. 渲染异步列表后，用 js 给链接加分页参数，（例如在 renderItems() 方法中）</p>
<pre><code>1.如果第2步使用 href 跳转：
</code></pre></li>
</ol>
<pre>
<code>var liA = DOM.query('#J_MaterialItems .J_LiA');

S.later(function(){

    for(var i=0;i<lia.length;i++){ var="" oldlink="DOM.attr(liA[i],'href');" newlink="oldLink+'&page_id='+listControl.pageId;" dom.attr(lia[i],'href',newlink);="" }="" },100)="" <="" code=""></lia.length;i++){></code></pre>


<p>如果第2步使用 onclick 跳转：</p>
<pre>
<code>Event.on('.J_LiA','click',function(ev){

    if(!showPermissions('editor_material','促销素材')){return ;}

    var link = DOM.attr(ev.currentTarget,'data-url');

window.location.href=link+'&page_id='+templet.pageId;
    //window.open(link+'&page_id='+templet.pageId);

})
</code></pre>

<p>加载列表的方法（例如：searchPutItems() ），第一行加入<br><code>var pageId = listControl.pageId;</code><br>加载列表的方法，发送的请求中多加参数<br><code>+&quot;&amp;page_id=&quot;+pageId</code><br>加载列表的方法，成功后的回调（例如：submitHandle() ），渲染完分页后，再指定分页跳转；例如：</p>
<pre>
<code>if(pageId > 1){
    listControl.paginator.setPage(pageId).setPageCount(pageCount).printHtml('#J_Paging',2);
}
</code></pre>

<p>分页操作的方法第一行加入：<br><code>listControl.pageId  = turnTo;</code><br>在列表页跳出的操作页面，给需要跳回上次所在分页的链接所在的 php echo 方法中加入<br><code>,array(&#39;page_id&#39;=&gt;$this-&gt;getRequest()-&gt;getParam(&#39;page_id&#39;,&#39;1&#39;))</code><br>例如：</p>
  <pre><code>&lt;a href="<?php echo $this->getUrl('material/show/index',array('page_id'=>$this->getRequest()->getParam('page_id','1')))?>"></code></pre>



<p>—————————————————————方案2分割线————————————————————————</p>
<p>说明：只改动列表页所在的 js；</p>
<p>步骤：</p>
<p>分页控制方法中，把分页存入 sessionStorage：</p>
<pre>
<code>if(window.sessionStorage){
  var ss = window.sessionStorage;
  var last_pagination = {'udp_item_index' : turnTo};

  ss.setItem("hlg_ss_tbv3",JSON.stringify(last_pagination));

}
</code></pre>

<p>加载列表的方法中，读取 sessionStorage，并指定分页数：<br>a.获取分页数：</p>
<pre>
<code>var ss = window.sessionStorage;
var hlg_ss = JSON.parse(ss['hlg_ss_tbv3']);

if(ss && ss.getItem('hlg_ss_tbv3') && hlg_ss['udp_item_index']){

  var pageId = parseInt(hlg_ss['udp_item_index']);

 }else{

  var pageId = 1;

}
</code></pre>

<p>b.传参：<code>data += &quot;&amp;page_id=&quot;+pageId;</code></p>
<p>c.请求成功后跳转：</p>
<pre>
<code>if(pageId > 1){
    list.paginator.setPage(pageId).setPageCount(pageCount).printHtml('#J_Paging',2);
}
</code></pre>

    
	</article>
	

	
<div class="jiathis_style share">
    <span class="jiathis_txt">分享到：</span>
    <a class="jiathis_button_tsina">新浪微博</a>
    <a class="jiathis_button_tqq">腾讯微博</a>
    <a class="jiathis_button_weixin">微信</a>
    <a class="jiathis_button_twitter">Twitter</a>
    <a class="jiathis_button_googleplus">Google+</a>
    <a class="jiathis_button_evernote">EverNote</a>
    <a href="http://www.jiathis.com/share?uid=1501277" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
</div>
<script type="text/javascript" >
    var jiathis_config={
    data_track_clickback:true,
    sm:"copy,renren,cqq",
    pic:"",
    summary:"",
     ralateuid:{"tsina":"1530558400"},hideMore:false}
    
  </script> 
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=
" charset="utf-8"></script>      

	<div class="pagepart clearfix">
 
	<a href="/2014/02/27/use-vimdiff/" class="prev" title="查看代码变更（或审查代码）的建议">查看代码变更（或审查代码）的建议</a>
 
 
	<a href="/2013/12/31/hello-hexo/" class="next" title="Hello Hexo">Hello Hexo</a>
 
</div>
	
<section id="comments">
  <h1 class="title">交流区</h1>
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
    <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏">
        <i class="icon-menu"></i>
      </a></div>
    <div id="asidepart">
    <div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"><i class="icon-menu"></i></a></div>
    <aside>
  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>2</sup></a></li>
		
			<li><a href="/categories/Web前端/" title="Web前端">Web前端<sup>11</sup></a></li>
		
			<li><a href="/categories/php/" title="php">php<sup>1</sup></a></li>
		
			<li><a href="/categories/博客相关/" title="博客相关">博客相关<sup>6</sup></a></li>
		
			<li><a href="/categories/工具/" title="工具">工具<sup>4</sup></a></li>
		
			<li><a href="/categories/折腾/" title="折腾">折腾<sup>1</sup></a></li>
		
			<li><a href="/categories/读书笔记/" title="读书笔记">读书笔记<sup>2</sup></a></li>
		
			<li><a href="/categories/达者为师/" title="达者为师">达者为师<sup>2</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Linux/" title="Linux">Linux<sup>2</sup></a></li>
		
			<li><a href="/tags/Magento/" title="Magento">Magento<sup>1</sup></a></li>
		
			<li><a href="/tags/Octopress/" title="Octopress">Octopress<sup>5</sup></a></li>
		
			<li><a href="/tags/Web前端/" title="Web前端">Web前端<sup>11</sup></a></li>
		
			<li><a href="/tags/git/" title="git">git<sup>1</sup></a></li>
		
			<li><a href="/tags/hexo/" title="hexo">hexo<sup>1</sup></a></li>
		
			<li><a href="/tags/mp3tag/" title="mp3tag">mp3tag<sup>1</sup></a></li>
		
			<li><a href="/tags/php/" title="php">php<sup>1</sup></a></li>
		
			<li><a href="/tags/vim/" title="vim">vim<sup>2</sup></a></li>
		
			<li><a href="/tags/vimdiff/" title="vimdiff">vimdiff<sup>1</sup></a></li>
		
			<li><a href="/tags/工具/" title="工具">工具<sup>2</sup></a></li>
		
			<li><a href="/tags/折腾/" title="折腾">折腾<sup>5</sup></a></li>
		
			<li><a href="/tags/翻译/" title="翻译">翻译<sup>1</sup></a></li>
		
			<li><a href="/tags/读书笔记/" title="读书笔记">读书笔记<sup>7</sup></a></li>
		
			<li><a href="/tags/达者为师/" title="达者为师">达者为师<sup>5</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="RSS 订阅"><i class="icon-rss"></i>RSS 订阅</a>
</div>
</aside>
    </div>
  </div>
  <footer><div id="footer" >
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	<section class="info">
		<p>在开源的世界学习了很多 <br/>
		从具有开源精神的人身上学到更多……<br/>
		</p>
	</section>
	<div class="social-font">
		
		<a href="http://weibo.com/snger" target="_blank" title="新浪微博"><i class="icon-sina-weibo"></i></a>
		
		
		<a href="https://twitter.com/sjs_stef" target="_blank" title="twitter"><i class="icon-twitter"></i></a>
		
		
		<a href="https://github.com/snger" target="_blank" title="github"><i class="icon-github"></i></a>
		
		
	</div>
	<p class="copyright">Powered by <a href="http://zespia.tw/hexo/" target="_blank" title="hexo">hexo</a> and Theme forked from <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2015 
	
	<a href="http://snger.github.io" title="Snger">Snger</a>
	
	</p>
</div>
</footer>
  <script src="/js/jquery-2.0.1.min.js"></script>
<script src="/js/prettify.js"></script>
	<script type="text/javascript">
	$(document).ready(function()         
	{	
		$('.navbar').click(function(){
			$('header nav').slideToggle("slow");
		});
		var myWidth = 0;
    	function getSize(){
    		if( typeof( window.innerWidth ) == 'number' ) {
    			myWidth = window.innerWidth;
           	 } else if( document.documentElement && document.documentElement.clientWidth) {
             	myWidth = document.documentElement.clientWidth;
            };
        };
    	getSize(); 
    	//document.getElementById("test").innerHTML =myWidth;
        $(window).resize(function(){
        	getSize(); 
        	if (myWidth >= 1024||(document.activeElement.id=='search')) {
        		$('nav').css('display', 'block') ;
			}else{
				$('nav').css('display', 'none') ;
			}
        });
     $("pre").addClass("prettyprint linenums");
     prettyPrint();
     $('.closeaside').click(function(){
            $('#asidepart').fadeOut();
            $('#main').animate({
                marginLeft: ['10%','swing'],
                marginRight: ['10%','swing']
            });
            $('.openaside').fadeIn();  
        });
        $('.openaside').click(function(){
            $('#asidepart').fadeIn();
            $('#main').animate({
                marginLeft: ['0%','swing'],
                marginRight: ['0%','swing']
            });
            $('.openaside').fadeOut();  
        });
        $(window).scroll(function(){
            $('.openaside').css("top",Math.max(50,260-$(this).scrollTop()));
        });
	});
</script>

<script>
  var disqus_shortname = 'snger';
  
  var disqus_url = 'http://snger.github.io/2014/02/20/record-page-num/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-27385230-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

</body>
</html> 
